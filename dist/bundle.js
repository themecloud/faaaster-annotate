(()=>{"use strict";let e,n;function t(t,a){if(t.nodeType!==Node.ELEMENT_NODE)throw new Error("Can't generate CSS selector for non-element node type.");if("html"===t.tagName.toLowerCase())return"html";const l={root:document.body,idName:e=>!0,className:e=>!0,tagName:e=>!0,attr:(e,n)=>!1,seedMinLength:1,optimizedMinLength:2,threshold:1e3,maxNumberOfTries:1e4};e={...l,...a},n=function(e,n){return e.nodeType===Node.DOCUMENT_NODE?e:e===n.root?e.ownerDocument:e}(e.root,l);let s=o(t,"all",(()=>o(t,"two",(()=>o(t,"one",(()=>o(t,"none")))))));if(s){const e=y(E(s,t));return e.length>0&&(s=e[0]),i(s)}throw new Error("Selector was not found.")}function o(n,t,o){let i=null,l=[],s=n,h=0;for(;s;){let n=f(c(s))||f(...r(s))||f(...d(s))||f(u(s))||[{name:"*",penalty:3}];const v=m(s);if("all"==t)v&&(n=n.concat(n.filter(p).map((e=>g(e,v)))));else if("two"==t)n=n.slice(0,1),v&&(n=n.concat(n.filter(p).map((e=>g(e,v)))));else if("one"==t){const[e]=n=n.slice(0,1);v&&p(e)&&(n=[g(e,v)])}else"none"==t&&(n=[{name:"*",penalty:3}],v&&(n=[g(n[0],v)]));for(let e of n)e.level=h;if(l.push(n),l.length>=e.seedMinLength&&(i=a(l,o),i))break;s=s.parentElement,h++}return i||(i=a(l,o)),!i&&o?o():i}function a(n,t){const o=y(v(n));if(o.length>e.threshold)return t?t():null;for(let e of o)if(s(e))return e;return null}function i(e){let n=e[0],t=n.name;for(let o=1;o<e.length;o++){const a=e[o].level||0;t=n.level===a-1?`${e[o].name} > ${t}`:`${e[o].name} ${t}`,n=e[o]}return t}function l(e){return e.map((e=>e.penalty)).reduce(((e,n)=>e+n),0)}function s(e){const t=i(e);switch(n.querySelectorAll(t).length){case 0:throw new Error(`Can't select any node with this selector: ${t}`);case 1:return!0;default:return!1}}function c(n){const t=n.getAttribute("id");return t&&e.idName(t)?{name:"#"+CSS.escape(t),penalty:0}:null}function r(n){const t=Array.from(n.attributes).filter((n=>e.attr(n.name,n.value)));return t.map((e=>({name:`[${CSS.escape(e.name)}="${CSS.escape(e.value)}"]`,penalty:.5})))}function d(n){return Array.from(n.classList).filter(e.className).map((e=>({name:"."+CSS.escape(e),penalty:1})))}function u(n){const t=n.tagName.toLowerCase();return e.tagName(t)?{name:t,penalty:2}:null}function m(e){const n=e.parentNode;if(!n)return null;let t=n.firstChild;if(!t)return null;let o=0;for(;t&&(t.nodeType===Node.ELEMENT_NODE&&o++,t!==e);)t=t.nextSibling;return o}function g(e,n){return{name:e.name+`:nth-child(${n})`,penalty:e.penalty+1}}function p(e){return"html"!==e.name&&!e.name.startsWith("#")}function f(...e){const n=e.filter(h);return n.length>0?n:null}function h(e){return null!=e}function*v(e,n=[]){if(e.length>0)for(let t of e[0])yield*v(e.slice(1,e.length),n.concat(t));else yield n}function y(e){return[...e].sort(((e,n)=>l(e)-l(n)))}function*E(n,t,o={counter:0,visited:new Map}){if(n.length>2&&n.length>e.optimizedMinLength)for(let a=1;a<n.length-1;a++){if(o.counter>e.maxNumberOfTries)return;o.counter+=1;const l=[...n];l.splice(a,1);const c=i(l);if(o.visited.has(c))return;s(l)&&b(l,t)&&(yield l,o.visited.set(c,!0),yield*E(l,t,o))}}function b(e,t){return n.querySelector(i(e))===t}document.addEventListener("DOMContentLoaded",(function(){var e=appConfig.locale.substring(0,2),n=appConfig.user,o=appConfig.cookie,a=null;let i=!1;var l=window.location.protocol+"//"+window.location.host+window.location.pathname,s=(encodeURIComponent(l),(window.location.host+window.location.pathname).replace(/\//g,"-").replace(/\./g,"-"));function c(e){const n=document.cookie.split("; ");for(let t=0;t<n.length;t++){const o=n[t].split("=");if(o[0]===e)return o[1]}}console.log("cookie annotateMode",c("annotateMode"));let r=c("annotateMode")??!0;var d,u,m;o||(d=n,u="",(m=new Date).setTime(m.getTime()+6048e5),u="; expires="+m.toUTCString(),document.cookie="annotate="+(d||"")+u+"; path=/"),document.body.id="myCustomId";var g=document.createElement("button");function p(e){if(console.log("anno",a),!a)return!1;console.log("trigger element",e),i=!!document.querySelector(".r6o-editor");let n=!1;for(let t=0;t<e.childNodes.length;t++)e.childNodes[t].nodeType===Node.TEXT_NODE&&(n=!0);console.log("hasTextChildren",n),console.log("SIDEBAR CLICK",null!==e.closest("#annotationSidebar"));const t=e.nodeType===Node.TEXT_NODE||n;console.log(" trigger textEvent",t),console.log("trigger annotateblock",i);const o=null===e.closest(".r6o-editor")&&null===e.closest("#annotationSidebar")&&null===e.closest("#wpadminbar")&&!i&&!!t,l=null!==e.closest(".r6o-editor")||null!==e.closest("#annotationSidebar")||null!==e.closest("#wpadminbar")||!i&&!r;return console.log("trigger",o),[o,l]}function f(n){n.sort(((e,n)=>new Date(n.body[0].modified)-new Date(e.body[0].modified)));var t=document.getElementById("sidebar-annotations");t.innerHTML="",n.forEach((n=>{console.log("anno",n);const o=n.body[0].modified,a=new Date(o).toLocaleString(e);(s=document.createElement("li")).classList.add("sidebar-annotation-container"),s.dataset.annotationId=n.id,t.appendChild(s);var i=document.querySelector("[data-annotation-id='"+n.id+"'"),l=n.body.length-1,s=l>0?'<div class="sidebar-annotation"><div class="sidebar-annotation-content"><span class="sidebar-annotation-index"><span>'+n.index+"</span></span>"+n.body[0].value+'</div><div class="sidebar-annotation-meta"><span class="r6o-lastmodified-by">'+n.body[0].creator.name+'</span><span class="r6o-lastmodified-at"><time class="" datetime="1704493363444" timeago-id="1343">'+a+'</time></span><span class="anno-comments-number">'+l+"</span></div></div>":'<div class="sidebar-annotation"><div class="sidebar-annotation-content"><span class="sidebar-annotation-index"><span>'+n.index+"</span></span>"+n.body[0].value+'</div><div class="sidebar-annotation-meta"><span class="r6o-lastmodified-by">'+n.body[0].creator.name+'</span><span class="r6o-lastmodified-at"><time class="" datetime="1704493363444" timeago-id="1343">'+a+"</time></span></div></div>";i.innerHTML+=s}))}function h(){console.log("listen clicks");var e=document.getElementById("sidebar-annotations").getElementsByTagName("li");Array.from(e).forEach((e=>{e.addEventListener("click",(function(n){var t;n.target.closest("li").classList.add("anno-selected"),console.log(">>>> CLICK item",e),(t=e.dataset.annotationId,new Promise(((e,n)=>{var o=document.querySelectorAll(".r6o-annotation");Array.from(o).forEach((e=>{e.classList.remove("anno-selected")}));var a=document.querySelector(".r6o-annotation[data-id='"+t+"'");console.log("pageAnnotation",a),a?(console.log(">>>>>>>> SCROLL <<<<<<<<<"),a.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout((()=>{a.classList.add("anno-selected"),e()}),1e3),console.log(">>>> RESOLVE <<<<<")):n("Annotation not found")}))).then((()=>{console.log("item.dataset.annotationId",e.dataset.annotationId);const n=document.querySelector('.r6o-annotation[data-id="'+e.dataset.annotationId+'"]');if(n){console.log(">>>>>>>>>>>>> Element clicked",n),n.click();var t=new MouseEvent("mouseup",{isTrusted:!0,bubbles:!0,cancelable:!0,composer:!0,detail:1});n.dispatchEvent(t)}else console.log(">>>>>>>>> Element not found")}))}))}))}function v(e){e.forEach((e=>{var n=document.querySelectorAll("[data-id='"+e.id+"'");console.log(e.id," >> ",n.length);var t=document.querySelector(e.selector),o=!1;if(n.forEach((n=>{n.parentNode!==t?(n.classList.remove("r6o-annotation"),n.setAttribute("data-id","")):(n.style.setProperty("--after-content",'"'+e.index+'"'),o=!0)})),!o){const n=document.createElement("span");for(n.className="r6o-annotation",n.setAttribute("data-id",e.id),n.style.setProperty("--after-content",'"'+e.index+'"');t.firstChild;)n.appendChild(t.firstChild);t.appendChild(n),console.log("newElement",t)}}))}g.id="saveCommentButton",g.textContent="Save Comment",document.body.appendChild(g),g.addEventListener("click",(function(){a.loadAnnotations("/wp-json/annotate/v1/annotations/").then((function(e){console.log("annotations loaded",e)}))})),function(){var e=document.createElement("div");e.innerHTML+="<div id='sidebar-header'><div id='sidebar-title'><h2>Annotations</h2></div><div id='sidebar-help'><h4>Sélectionnez du texte pour ajouter un commentaire.<br>Cliquez sur un commentaire ci dessous pour le localiser dans la page.</h4></div></div><ul id='sidebar-annotations'></ul><div id='annotate-mode'><span class='mySwitchText'>Naviguer</span><input type='checkbox' id='mySwitch' /><label for='mySwitch' id='mySwitchLabel'>Annotate</label><span class='mySwitchText' style='text-align:right'>Annoter</span></div><div id='anno-minimize'><svg stroke='currentColor' fill='currentColor' stroke-width='0' viewBox='0 0 256 512' class='jss590' height='1em' width='1em' xmlns='http://www.w3.org/2000/svg'><path d='M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z'></path></svg></div>",e.id="annotationSidebar",document.body.appendChild(e);const n=document.getElementById("mySwitch");n.checked=!0,document.getElementById("wpadminbar")&&e.classList.add("annotationAdmin"),n.addEventListener("change",(function(){console.log("test switch",this.checked),r=this.checked,console.log("annotateMode state is now:",r),0==r?(console.log("DESTROY ANNO"),document.querySelectorAll(".r6o-annotation").forEach((function(e){e.classList.replace("r6o-annotation","r6o-annotation-hidden")})),document.cookie="annotateMode=false; path=/"):(document.querySelectorAll(".r6o-annotation-hidden").forEach((function(e){e.classList.replace("r6o-annotation-hidden","r6o-annotation")})),document.cookie="annotateMode=true; path=/")})),document.getElementById("anno-minimize").addEventListener("click",(function(){!function(){const e=document.getElementById("annotationSidebar");e.classList.contains("sideBarHidden")?(console.log("Open SideBar"),e.classList.remove("sideBarHidden")):(console.log("Close SideBar"),e.classList.add("sideBarHidden"))}()}))}(),function(){console.log("INITIALIZE ANNO"),a=Recogito.init({content:document.getElementById("myCustomId"),locale:e,widgets:[{widget:"COMMENT"},{widget:"TAG",vocabulary:["Nouveau","En cours","À valider","Validé"]}]});const t={id:window.location.protocol+"//"+window.location.host+"/"+n,displayName:n};console.log("args",t),a.setAuthInfo(t),a.loadAnnotations("/wp-json/annotate/v1/annotations?url="+s).then((function(e){if(console.log("annotations loaded",e),f(e),v(e),h(),console.log("change switch",c("annotateMode")),"false"==c("annotateMode")){console.log("switch false");const e=document.getElementById("mySwitch");e.checked=!1;const n=new Event("change",{bubbles:!0,cancelable:!0});e.dispatchEvent(n)}}))}();var y=null;document.addEventListener("mousedown",(function(e){var n;if(console.log("mouseDown trigger",p(e.target)[0]),r){if(1==p(e.target)[0]){console.log("mouseDown >> TRIGGER"),e.stopPropagation(),e.preventDefault();var o=e.target;console.log("before unique selector"),n=t(o),console.log(n),y=n;var a=window.getSelection();console.log("clickedElement",o);var i=document.createRange();i.selectNodeContents(o),console.log("range",i),a.removeAllRanges(),a.addRange(i)}}else e.stopPropagation()})),document.addEventListener("mouseup",(function(e){console.log(">>>> MOUSE UP FORCE",e.target),r?e.target.classList.contains("sidebar-annotation-container")&&(console.log("STOP PROPAGATRE CONTAINER"),e.stopPropagation()):e.stopPropagation()}),!0),document.addEventListener("mouseup",(function(e){console.log(">>>> MOUSE UP",e.target),r?1==p(e.target)[0]&&(console.log(">>>>> STOP PROPAGATION MOUSE UP"),e.stopPropagation()):e.stopPropagation()})),document.addEventListener("click",(function(e){r&&(i||e.target.classList.contains("r6o-annotation")||e.target.classList.contains("sidebar-annotation-container")||(console.log("UNSELECT"),document.querySelectorAll(".r6o-annotation").forEach((e=>{e.classList.remove("anno-selected")})),document.querySelectorAll(".sidebar-annotation-container").forEach((e=>{e.classList.remove("anno-selected")}))),p(e.target)[1]||(console.log(">>>>> STOP DEFAULT PROPAGATION CKICKTHROUGH FALSE"),e.preventDefault()),p(e.target)[0]&&(console.log(">>>>> STOP DEFAULT PROPAGATION CLICK TRIGGER TRUE"),e.preventDefault()))})),a.on("createAnnotation",(function(e){console.log("encodedPathName",s);var n=a.getAnnotations();n.sort(((e,n)=>new Date(e.body[0].created)-new Date(n.body[0].created))),n.forEach(((e,n)=>{e.index=n})),console.log("commentsData",n);var t=n.findIndex((n=>n.id===e.id));console.log("index",t,"id",e.id),n[t].url=s,console.log("uniqueSelector",y),n[t].selector=y,f(n),v(n),h(),console.log("commentsData",n),fetch("/wp-json/annotate/v1/proxy/?url="+s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>console.log("Success:",e))).catch((e=>console.error("Error:",e))),console.log("Annotation created:",e)})),a.on("updateAnnotation",(function(e){console.log("encodedPathName",s);var n=a.getAnnotations();n.sort(((e,n)=>new Date(e.body[0].created)-new Date(n.body[0].created))),n.forEach(((e,n)=>{e.index=n})),console.log("commentsData",n);var t=n.findIndex((n=>n.id===e.id));n[t].url=s,console.log("uniqueSelector",y),n[t].selector=y,f(n),v(n),h(),console.log("commentsData",n),fetch("/wp-json/annotate/v1/proxy/?url="+s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>console.log("Success:",e))).catch((e=>console.error("Error:",e))),console.log("Annotation updated:",e)}))}))})();